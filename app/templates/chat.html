{% extends "base.html" %}

{% block content %}
<div class="flex-1 flex flex-col p-6 overflow-y-hidden bg-zinc-900">
    <div id="message-container" class="flex-1 overflow-y-auto bg-inherit p-2 pb-16">
        {% for message in messages %}
        <div id="message-{{ message.id }}"
            class="mb-4 w-2/3 {{ 'float-right user-message' if message.user_message else 'float-left ai-message' }} bg-zinc-700 p-4 rounded-2xl relative">
            <div class="markdown-content text-white whitespace-pre-wrap break-words">{{ message.text }}</div>
            <span class="text-sm text-slate-500">{{ moment(message.created_at).calendar() }}</span>
            <a class="text-sm text-slate-500 px-8 hover:text-slate-300"
                href="{{ url_for('chats', chat_id=chat.id, message_id=message.id) }}">{{ message.id }}</a>


            <input type="hidden" class="children" value='{{ message.children|tojson }}'>
            <input type="hidden" class="current-child-idx"
                value='{{ message.children.index(messages[loop.index].id) if message.children }}'>
        </div>
        {% endfor %}
    </div>

    {% if not chat.completed %}
    <form method="POST" id="message-form" class="flex">
        <textarea id="message-input" type="text" name="message"
            class="flex-1 p-2 border rounded-2xl bg-zinc-700 text-white" rows="10" placeholder=""></textarea>
        <button type="submit"
            class="ml-2 bg-gray-500 text-white p-2 rounded hover:bg-gray-700 cursor-pointer">Send</button>
    </form>
    {% endif %}
</div>

<input type="hidden" id="chat-id" value="{{ chat.id }}">

<script>
    const copySVG = `<svg width="24px" height="24px" viewBox="0 0 24 24" fill="#ffffff" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M21 8C21 6.34315 19.6569 5 18 5H10C8.34315 5 7 6.34315 7 8V20C7 21.6569 8.34315 23 10 23H18C19.6569 23 21 21.6569 21 20V8ZM19 8C19 7.44772 18.5523 7 18 7H10C9.44772 7 9 7.44772 9 8V20C9 20.5523 9.44772 21 10 21H18C18.5523 21 19 20.5523 19 20V8Z" fill="#ffffff"/><path d="M6 3H16C16.5523 3 17 2.55228 17 2C17 1.44772 16.5523 1 16 1H6C4.34315 1 3 2.34315 3 4V18C3 18.5523 3.44772 19 4 19C4.55228 19 5 18.5523 5 18V4C5 3.44772 5.44772 3 6 3Z"/></svg>`;
    const forkSVG = `<svg width="24px" height="24px" fill="#ffffff" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 33.627 33.628"xml:space="preserve"><g><path d="M27.131,8.383c0-2.092-1.701-3.794-3.794-3.794s-3.793,1.702-3.793,3.794c0,0.99,0.39,1.885,1.013,2.561c-0.474,2.004-1.639,2.393-4.167,3.029c-1.279,0.322-2.753,0.7-4.099,1.501V7.003c1.072-0.671,1.793-1.854,1.793-3.209C14.084,1.702,12.382,0,10.292,0C8.199,0,6.497,1.702,6.497,3.794c0,1.356,0.722,2.539,1.795,3.21v19.62c-1.073,0.671-1.795,1.854-1.795,3.21c0,2.092,1.702,3.794,3.795,3.794c2.092,0,3.793-1.702,3.793-3.794c0-1.355-0.722-2.539-1.793-3.209v-3.846c0.496-3.768,2.321-4.232,5.075-4.926c2.527-0.637,5.955-1.513,7.048-5.852C25.981,11.535,27.131,10.099,27.131,8.383z M10.292,2.002c0.988,0,1.793,0.805,1.793,1.794c0,0.989-0.806,1.793-1.793,1.793c-0.989,0-1.795-0.805-1.795-1.793C8.498,2.806,9.302,2.002,10.292,2.002z M10.292,31.627c-0.989,0-1.795-0.807-1.795-1.794c0-0.989,0.806-1.793,1.795-1.793c0.988,0,1.793,0.806,1.793,1.793C12.085,30.824,11.28,31.627,10.292,31.627z M23.337,10.177c-0.989,0-1.793-0.805-1.793-1.793c0-0.989,0.806-1.794,1.793-1.794c0.988,0,1.794,0.805,1.794,1.794C25.131,9.373,24.327,10.177,23.337,10.177z"/></g></svg>`;
    const arrowLeftSVG = `<svg fill=" #ffffff" width="18px" height="18px" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"> <path d="M23.505 0c0.271 0 0.549 0.107 0.757 0.316 0.417 0.417 0.417 1.098 0 1.515l-14.258 14.264 14.050 14.050c0.417 0.417 0.417 1.098 0 1.515s-1.098 0.417-1.515 0l-14.807-14.807c-0.417-0.417-0.417-1.098 0-1.515l15.015-15.022c0.208-0.208 0.486-0.316 0.757-0.316z"> </path> </svg>`;
    const arrowRightSVG = `<svg fill=" #ffffff" width="18px" height="18px" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"> <path d="M8.489 31.975c-0.271 0-0.549-0.107-0.757-0.316-0.417-0.417-0.417-1.098 0-1.515l14.258-14.264-14.050-14.050c-0.417-0.417-0.417-1.098 0-1.515s1.098-0.417 1.515 0l14.807 14.807c0.417 0.417 0.417 1.098 0 1.515l-15.015 15.022c-0.208 0.208-0.486 0.316-0.757 0.316z"> </path></svg>`;

    const forkArrowsCSS = ["inline-flex", "items-center", "justify-center", "p-2", "rounded-lg"]


    function addCopyButton(codeBlock) {
        const button = document.createElement("button");
        button.classList.add("copy-btn");
        button.innerHTML = copySVG;

        const preBlock = codeBlock.parentNode;
        preBlock.style.position = "relative";
        preBlock.appendChild(button);

        button.addEventListener("click", () => {
            const codeText = codeBlock.textContent || codeBlock.innerText;
            navigator.clipboard
                .writeText(codeText)
                .then(() => { })
                .catch(() => { });
        });
    }

    function addForkButtons(message, hidden = false) {
        const forkPages = document.createElement("div");
        forkPages.classList.add("fork-pages", "float-right", "flex", "flex-row");
        if (hidden) {
            forkPages.classList.add("hidden");
        }
        message.appendChild(forkPages);

        const backArrow = document.createElement("a");
        backArrow.innerHTML = arrowLeftSVG;
        backArrow.classList.add(...forkArrowsCSS);
        forkPages.appendChild(backArrow);

        const text = document.createElement("span");
        text.classList.add("text-white", "text-xl");
        forkPages.appendChild(text);

        const forwardArrow = document.createElement("a");
        forwardArrow.innerHTML = arrowRightSVG;
        forwardArrow.classList.add(...forkArrowsCSS);
        forkPages.appendChild(forwardArrow);

        const forkButton = document.createElement("button");
        forkButton.classList.add("fork-btn", "hidden");
        forkButton.innerHTML = forkSVG;
        message.appendChild(forkButton);

        forkButton.addEventListener("click", () => {
            const messages = [...document.querySelectorAll("#message-container >div")];
            const forkIdx = messages.findIndex((el) => el === message);

            if (forkIdx !== messages.length - 1) {
                for (let i = messages.length - 1; i > forkIdx; i--) {
                    messages[i].remove();
                }

                const forkPages = message.querySelector(".fork-pages");
                forkPages.classList.remove("hidden");

                const text = forkPages.querySelector("span");
                const lastPage = parseInt(text.textContent.split("/")[1]) + 1;
                text.textContent = `${lastPage}/${lastPage}`;

                const childrenIds = JSON.parse(message.querySelector(".children").value);
                const arrows = forkPages.querySelectorAll("a");

                arrows[0].href = `${arrows[0].href.split("?")[0]}?message_id=${childrenIds[childrenIds.length - 1]}`;
                arrows[1].href = `${arrows[1].href.split("?")[0]}?message_id=${childrenIds[0]}`;

                forkPages.classList.remove("hidden");
            }
        });

    }

    function updateForkPages(message, newChild = null) {
        const forkPages = message.querySelector(".fork-pages");
        const backArrow = forkPages.querySelector("a");
        const text = forkPages.querySelector("span");
        const forwardArrow = forkPages.querySelectorAll("a")[1];

        const messageChildren = message.querySelector(".children");
        const messageChildrenIdx = message.querySelector(".current-child-idx");

        let childrenIds = JSON.parse(messageChildren.value);
        let currChildIdx = parseInt(messageChildrenIdx.value);

        if (newChild) {
            childrenIds.push(newChild);
            messageChildren.value = JSON.stringify(childrenIds);

            currChildIdx = childrenIds.length - 1;
            messageChildrenIdx.value = currChildIdx;
        }

        if (isNaN(currChildIdx) || childrenIds.length <= 1) {
            forkPages.classList.add("hidden");
        } else {
            forkPages.classList.remove("hidden");
        }

        if (childrenIds.length != 0) {
            message.querySelector(".fork-btn").classList.remove("hidden");
        }

        backArrow.href = `${window.location.pathname}?message_id=${childrenIds[(childrenIds.length + currChildIdx - 1) % childrenIds.length]}`;
        text.textContent = `${currChildIdx + 1}/${childrenIds.length}`;
        forwardArrow.href = `${window.location.pathname}?message_id=${childrenIds[(currChildIdx + 1) % childrenIds.length]}`;
    }

    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".markdown-content").forEach((el) => {
            const escapedContent = el.textContent.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const markdownContent = marked.parse(escapedContent);

            el.innerHTML = DOMPurify.sanitize(markdownContent);
        });


        document.querySelectorAll(".ai-message").forEach((el) => {
            addForkButtons(el);
            updateForkPages(el);
        });

        document.querySelectorAll("pre code").forEach((el) => {
            addCopyButton(el);
            hljs.highlightElement(el);
        });

        const message_id = new URLSearchParams(window.location.search).get("message_id");
        if (message_id) {
            const message = document.getElementById(`message-${message_id}`);
            if (message) {
                message.scrollIntoView({ block: "center", behavior: "smooth" });
                message.classList.add("chat-highlight");
            }
        }
    });
</script>

{% if not chat.completed %}
<script src="{{ url_for('static',filename='scripts/chat.js') }}"></script>
{% endif %}
{% endblock %}