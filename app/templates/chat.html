{% extends "base.html" %}

{% block content %}
<div class="flex-1 flex flex-col p-6 overflow-y-hidden bg-zinc-900">
    <div id="message-container" class="flex-1 overflow-y-auto bg-inherit">
        {% for message in messages %}
        <div id="message-{{ message.id }}"
            class="mb-4 w-2/3 {{ 'float-right' if message.user_message else 'float-left' }} bg-zinc-700 p-4 rounded-2xl">
            <div class="markdown-content text-white whitespace-pre-wrap">{{ message.text }}</div>
            <span class="text-xs text-slate-500">{{ message.created_at }}</span>
        </div>
        {% endfor %}
    </div>

    <form method="POST" id="message-form" class="flex">
        <textarea id="message-input" type="text" name="message"
            class="flex-1 p-2 border rounded-2xl bg-zinc-700 text-white" rows="10" placeholder=""></textarea>
        <button type="submit" class="ml-2 bg-gray-500 text-white p-2 rounded">Send</button>
    </form>
</div>

<input type="hidden" id="chat-id" value="{{ chat.id }}">

<script>
    const messageContainer = document.getElementById("message-container");
    const bubbleElements = document.getElementsByClassName("markdown-content");
    for (const e of bubbleElements) {
        e.innerHTML = DOMPurify.sanitize(marked.parse(e.textContent));
    }

    const chatId = document.getElementById("chat-id").value;
    const socket = io.connect(window.location.origin);

    socket.emit("join", chatId);

    socket.on("new_message", (message) => {
        const bubbleEl = document.createElement("div");
        bubbleEl.id = `message-${message.id}`;
        bubbleEl.classList.add(message.user_message ? "float-right" : "float-left",
            "mb-4", "w-2/3", "bg-zinc-700", "p-4", "rounded-2xl", "chat-loading");

        const textEl = document.createElement("p");
        textEl.classList.add("text-white", "whitespace-pre-wrap");

        if (message.stream) {
            textEl.textContent = message.text;
        } else {
            bubbleEl.classList.remove("chat-loading");
            textEl.classList.add("markdown-content");
            textEl.innerHTML = DOMPurify.sanitize(marked.parse(message.text));
        }

        const dateEl = document.createElement("span");
        dateEl.classList.add("text-xs", "text-slate-500");
        dateEl.textContent = message.created_at;

        bubbleEl.appendChild(textEl);
        bubbleEl.appendChild(dateEl);
        messageContainer.appendChild(bubbleEl);

        messageContainer.scrollTop = messageContainer.scrollHeight;
    });

    socket.on("new_message_stream", (chunk) => {
        const bubbleEl = document.getElementById(`message-${chunk.message_id}`);
        const textEl = bubbleEl.querySelector("p");

        textEl.textContent += chunk.text;

        messageContainer.scrollTop = messageContainer.scrollHeight;
    });

    socket.on("new_message_done", (message) => {
        const bubbleEl = document.getElementById(`message-${message.message_id}`);
        bubbleEl.classList.remove("chat-loading");

        const textEl = bubbleEl.querySelector("p");
        textEl.classList.add("markdown-content");
        textEl.innerHTML = DOMPurify.sanitize(marked.parse(textEl.textContent));

        messageContainer.scrollTop = messageContainer.scrollHeight;
    });

    function sendMessage() {
        const text = document.getElementById("message-input").value;

        if (text.trim()) {
            socket.emit("send_message", {
                chat_id: chatId,
                sender: "user",
                text: text
            });

            document.getElementById("message-input").value = "";
        }
    }

    document.getElementById("message-form").onsubmit = (e) => {
        event.preventDefault();
        sendMessage();
    };

    document.getElementById("message-input").addEventListener("keypress", e => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
{% endblock %}